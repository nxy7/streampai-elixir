services:
  timescaledb:
    container_name: ${COMPOSE_PROJECT_NAME:-streampai}_db
    image: timescale/timescaledb:latest-pg16
    restart: unless-stopped
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      TIMESCALEDB_TELEMETRY: "off"
    command: >
      postgres
      -c max_connections=500
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c wal_level=logical
      -c max_worker_processes=32
      -c max_parallel_workers=8
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  pgweb:
    container_name: ${COMPOSE_PROJECT_NAME:-streampai}_pgweb
    restart: unless-stopped
    image: sosedoff/pgweb
    ports:
      - "${PGWEB_PORT:-8082}:8081"
    environment:
      - PGWEB_DATABASE_URL=postgresql://postgres:postgres@timescaledb:5432/postgres?sslmode=disable
    depends_on:
      timescaledb:
        condition: service_healthy

  minio:
    container_name: ${COMPOSE_PROJECT_NAME:-streampai}_minio
    image: minio/minio:latest
    restart: unless-stopped
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  whisper-live:
    container_name: ${COMPOSE_PROJECT_NAME:-streampai}_whisper
    image: whisperlive-cpu:local
    restart: unless-stopped
    ports:
      - "${WHISPER_PORT:-9090}:9090"
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G
    volumes:
      - whisper_models:/root/.cache/huggingface
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import socket; s=socket.socket(); s.connect((\"localhost\",9090)); s.close()'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  timescaledb_data:
    driver: local
  minio_data:
    driver: local
  whisper_models:
    driver: local
