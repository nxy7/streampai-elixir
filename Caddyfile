# Caddyfile for local development with HTTPS
# This provides HTTPS for secure cookie handling and API testing.
#
# Usage:
#   # Start Caddy:
#   caddy run --config Caddyfile
#
# Or with environment variable override:
#   CADDY_PORT=8080 PHOENIX_PORT=4000 FRONTEND_PORT=3000 caddy run --config Caddyfile
#
# Make sure to run `caddy trust` first to install local CA certificates.

{
	# Disable auto HTTPS redirect to avoid binding to port 80
	auto_https disable_redirects

	# Use HTTP/1.1 only - Caddy 2.10.2 has WebSocket issues with HTTP/2
	# See: https://github.com/caddyserver/caddy/issues/7292
	servers {
		protocols h1
	}
}

localhost:{$CADDY_PORT:8000} {
	# All backend routes are prefixed with /api - proxy to Phoenix
	handle /api/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Admin routes (internal only, not prefixed)
	handle /admin/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Tidewave MCP for Claude integration
	handle /tidewave/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Vite HMR WebSocket - client router (must be before generic /_build/*)
	handle /_build/_hmr/client {
		reverse_proxy localhost:24678
	}

	# Vite HMR WebSocket - server router
	handle /_build/_hmr/server {
		reverse_proxy localhost:24679
	}

	# Vite HMR WebSocket - server-function router
	handle /_build/_hmr/server-function {
		reverse_proxy localhost:24680
	}

	# Vite dev server assets (all other /_build/* paths)
	handle /_build/* {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Enable gzip compression
	encode gzip

	# Log requests in development
	log {
		output stdout
		format console
	}
}
