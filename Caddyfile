# Caddyfile for local development with HTTP/2
# This enables HTTP/2 multiplexing to avoid the browser's 6 connection limit
# which can cause slowdowns when using many Electric SQL shapes.
#
# Usage:
#   caddy run --config Caddyfile
#
# Or with environment variable override:
#   CADDY_PORT=8080 PHOENIX_PORT=4000 FRONTEND_PORT=3000 caddy run --config Caddyfile
#
# Make sure to run `caddy trust` first to install local CA certificates.

{
	# Disable auto HTTPS redirect to avoid binding to port 80
	auto_https disable_redirects
}

localhost:{$CADDY_PORT:8000} {
	# All backend routes are prefixed with /api - proxy to Phoenix
	handle /api/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Admin routes (internal only, not prefixed)
	handle /admin/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Tidewave MCP for Claude integration
	handle /tidewave/* {
		reverse_proxy localhost:{$PHOENIX_PORT:4000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Enable gzip compression
	encode gzip

	# Log requests in development
	log {
		output stdout
		format console
	}
}
