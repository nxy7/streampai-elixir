# Caddyfile for local development with HTTPS
# This provides HTTPS for secure cookie handling and API testing.
#
# Usage:
#   # Start Caddy:
#   caddy run --config Caddyfile
#
# Or with environment variable override:
#   CADDY_PORT=8080 PORT=4000 FRONTEND_PORT=3000 caddy run --config Caddyfile
#
# Make sure to run `caddy trust` first to install local CA certificates.

{
	# Disable auto HTTPS redirect to avoid binding to port 80
	auto_https disable_redirects
}

localhost:{$CADDY_PORT:8000} {
	# All backend routes are prefixed with /api - proxy to Phoenix
	# Use 127.0.0.1 (IPv4) to avoid Docker Desktop's IPv6 listener on the same port
	handle /api/* {
		reverse_proxy 127.0.0.1:{$PORT:4000}
	}

	# Admin routes (internal only, not prefixed)
	handle /admin/* {
		reverse_proxy 127.0.0.1:{$PORT:4000}
	}

	# Tidewave MCP for Claude integration
	handle /tidewave/* {
		reverse_proxy 127.0.0.1:{$PORT:4000}
	}

	# Vite HMR WebSocket (proxied through Caddy for TLS)
	handle /_build/_hmr {
		reverse_proxy localhost:{$FRONTEND_HMR_PORT:3001}
	}

	# Vite dev server assets
	handle /_build/* {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Enable gzip compression
	encode gzip

	# Logs disabled by default to reduce noise (Phoenix/frontend already log)
	# Uncomment to enable Caddy access logs:
	# log {
	# 	output stdout
	# 	format console
	# }
}
