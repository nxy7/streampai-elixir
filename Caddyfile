# Caddyfile for local development with HTTPS
# This provides HTTPS for secure cookie handling and API testing.
#
# Supports two modes:
# 1. Port-based (legacy): https://localhost:8000
# 2. Domain-based: https://streampai.{branch}.localhost
#
# Usage:
#   # Start Caddy:
#   caddy run --config Caddyfile
#
# Or with environment variable override:
#   CADDY_PORT=8080 PORT=4000 FRONTEND_PORT=3000 caddy run --config Caddyfile
#
# For domain-based access, set LOCAL_DOMAIN in .env (e.g., streampai.my-branch.localhost)
#
# Make sure to run `caddy trust` first to install local CA certificates.

{
	# Disable auto HTTPS redirect to avoid binding to port 80
	auto_https disable_redirects
}

# Domain-based routing (when LOCAL_DOMAIN is set)
# Uses standard HTTPS port 443 for cleaner URLs
{$LOCAL_DOMAIN:} {
	# Skip this block if LOCAL_DOMAIN is not set (empty matcher)
	@domain_set expression `"{$LOCAL_DOMAIN}" != ""`

	# All backend routes are prefixed with /api - proxy to Phoenix
	handle /api/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Admin routes (internal only, not prefixed)
	handle /admin/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Tidewave MCP for Claude integration
	handle /tidewave/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Vite HMR WebSocket - client router
	handle /_build/_hmr/client {
		reverse_proxy localhost:{$FRONTEND_HMR_CLIENT_PORT:3001}
	}

	# Vite HMR WebSocket - server router
	handle /_build/_hmr/server {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_PORT:3002}
	}

	# Vite HMR WebSocket - server-function router
	handle /_build/_hmr/server-function {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_FUNCTION_PORT:3003}
	}

	# Vite dev server assets
	handle /_build/* {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	encode gzip
	log {
		output stdout
		format console
	}
}

# Port-based routing (fallback, always available)
localhost:{$CADDY_PORT:8000} {
	# All backend routes are prefixed with /api - proxy to Phoenix
	handle /api/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Admin routes (internal only, not prefixed)
	handle /admin/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Tidewave MCP for Claude integration
	handle /tidewave/* {
		reverse_proxy localhost:{$PORT:4000}
	}

	# Vite HMR WebSocket - client router (must be before generic /_build/*)
	handle /_build/_hmr/client {
		reverse_proxy localhost:{$FRONTEND_HMR_CLIENT_PORT:3001}
	}

	# Vite HMR WebSocket - server router
	handle /_build/_hmr/server {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_PORT:3002}
	}

	# Vite HMR WebSocket - server-function router
	handle /_build/_hmr/server-function {
		reverse_proxy localhost:{$FRONTEND_HMR_SERVER_FUNCTION_PORT:3003}
	}

	# Vite dev server assets (all other /_build/* paths)
	handle /_build/* {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Everything else goes to frontend
	handle {
		reverse_proxy localhost:{$FRONTEND_PORT:3000}
	}

	# Enable gzip compression
	encode gzip

	# Log requests in development
	log {
		output stdout
		format console
	}
}
